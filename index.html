<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÑ Christmas Gift Trivia (30 Questions)</title>
  <style>
    :root{
      --bg1:#071521;
      --bg2:#0b1b2a;
      --card: rgba(12, 34, 54, .80);
      --card2: rgba(12, 34, 54, .62);
      --text:#f6f7fb;
      --muted:#c7d3e3;
      --gold:#ffcc00;
      --green:#35d07f;
      --red:#ff5a5f;
      --line: rgba(255,255,255,.16);
      --glow: 0 0 22px rgba(255, 204, 0, .22);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1400px 900px at 15% 10%, #164f7e 0%, var(--bg2) 55%, var(--bg1) 100%);
      overflow-x:hidden;
    }
    .snow{ position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0; }
    .flake{
      position:absolute; top:-10px; border-radius: 50%;
      background: rgba(255,255,255,.85);
      filter: drop-shadow(0 0 6px rgba(255,255,255,.35));
      animation: fall linear infinite;
      opacity: .9;
    }
    @keyframes fall{ to { transform: translateY(110vh) translateX(30px); } }

    .wrap{ width:min(1400px, 96vw); margin: 0 auto; padding: 20px 0 30px; position:relative; z-index: 1; }

    .ribbon{
      background: linear-gradient(90deg, rgba(255,90,95,.18), rgba(255,204,0,.18), rgba(53,208,127,.18));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      padding: 14px 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
    }
    .ribbonTop{
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px; flex-wrap: wrap;
    }
    .title{
      display:flex; align-items:center; gap: 10px;
      font-weight: 1000; letter-spacing: .3px;
      font-size: clamp(20px, 2.2vw, 34px);
      text-shadow: 0 2px 18px rgba(0,0,0,.35);
    }
    .pills{ display:flex; gap: 10px; flex-wrap: wrap; }
    .pill{
      display:flex; gap: 10px; align-items:center;
      padding: 10px 14px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.16);
      font-weight: 900; font-size: clamp(14px, 1.2vw, 18px);
    }
    .pill small{ color: var(--muted); font-weight: 900; }

    .grid{ display:grid; grid-template-columns: 1.35fr .65fr; gap: 14px; margin-top: 14px; }
    @media (max-width: 1050px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
    }
    .sub{ color: var(--muted); margin: 0 0 14px; font-size: clamp(14px, 1.2vw, 18px); font-weight: 750; }

    label{ display:block; font-weight: 1000; margin-bottom: 8px; font-size: clamp(14px, 1.1vw, 18px); }
    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: 14px 14px;
      border-radius: 16px;
      outline: none;
      font-size: clamp(16px, 1.4vw, 20px);
      font-weight: 850;
    }
    textarea{ min-height: 120px; resize: vertical; }
    .row{ display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .field{ flex: 1; min-width: 260px; }
    .divider{ height: 1px; background: rgba(255,255,255,.14); margin: 16px 0; }

    button{
      appearance:none; border:0; cursor:pointer;
      padding: 14px 16px; border-radius: 16px;
      font-weight: 1000; letter-spacing: .2px;
      font-size: clamp(15px, 1.2vw, 18px);
      color: var(--text);
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      min-width: 160px;
      transition: transform .08s ease;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .btnStart{
      background: linear-gradient(90deg, rgba(255,90,95,.22), rgba(255,204,0,.22), rgba(53,208,127,.22));
      border-color: rgba(255,255,255,.22);
      box-shadow: var(--glow);
    }
    .btnDanger{ background: rgba(255,90,95,.18); border-color: rgba(255,90,95,.38); }
    .btnNext{ background: rgba(255,204,0,.18); border-color: rgba(255,204,0,.42); box-shadow: var(--glow); }

    .turnRow{ display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap; }
    .turnChip{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 14px; border-radius: 999px;
      border: 1px solid rgba(255,204,0,.35);
      background: rgba(255,204,0,.10);
      color: var(--gold);
      font-weight: 1000;
      font-size: clamp(16px, 1.4vw, 22px);
      box-shadow: var(--glow);
    }
    .turnChip span{ color: var(--text); }

    .badge{
      display:inline-flex; align-items:center; gap: 10px;
      padding: 10px 14px; border-radius: 16px;
      border: 1px solid rgba(255,204,0,.35);
      background: rgba(255,204,0,.12);
      color: var(--gold);
      font-weight: 1000;
      font-size: clamp(14px, 1.1vw, 18px);
      margin-bottom: 12px;
      box-shadow: var(--glow);
    }
    .badge span{ color: var(--text); }

    .qtext{
      font-size: clamp(22px, 2.2vw, 40px);
      font-weight: 1000;
      line-height: 1.15;
      margin: 8px 0 14px;
      text-shadow: 0 2px 22px rgba(0,0,0,.25);
    }
    .hint{ color: var(--muted); margin: 0 0 12px; font-size: clamp(14px, 1.1vw, 18px); font-weight: 800; }

    .choices{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 800px){ .choices{ grid-template-columns: 1fr; } }

    .choiceBtn{
      text-align:left;
      padding: 18px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      font-weight: 1000;
      font-size: clamp(18px, 1.6vw, 26px);
      line-height: 1.18;
      position: relative;
    }
    .choiceLabel{
      display:inline-block;
      width: 44px; height: 44px;
      border-radius: 14px;
      margin-right: 12px;
      vertical-align: middle;
      text-align:center;
      line-height: 44px;
      font-size: 20px;
      font-weight: 1000;
      background: rgba(255,204,0,.18);
      border: 1px solid rgba(255,204,0,.35);
      color: var(--gold);
      box-shadow: var(--glow);
    }
    .choiceBtn:disabled{ opacity:.55; cursor:not-allowed; }

    .status{
      margin-top: 12px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.08);
      border: 1px dashed rgba(255,255,255,.22);
      display:none;
      font-weight: 900;
      font-size: clamp(16px, 1.3vw, 20px);
    }
    .status.show{ display:block; }
    .status.good{ border-color: rgba(53,208,127,.55); }
    .status.bad{ border-color: rgba(255,90,95,.55); }

    .pickGift{
      margin-top: 12px;
      padding: 16px;
      border-radius: 18px;
      background: rgba(53,208,127,.12);
      border: 1px solid rgba(53,208,127,.35);
      display:none;
      font-weight: 1000;
      font-size: clamp(18px, 1.5vw, 24px);
    }
    .pickGift.show{ display:block; }

    .scoreTable{
      width:100%;
      border-collapse: collapse;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: var(--card2);
    }
    .scoreTable th, .scoreTable td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      text-align:left;
      font-weight: 950;
      font-size: clamp(14px, 1.1vw, 18px);
    }
    .scoreTable th{
      color: var(--muted);
      font-size: clamp(12px, 1.0vw, 14px);
      text-transform: uppercase;
      letter-spacing: .8px;
    }

    .adminHidden{ display:none; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>

  <div class="wrap">
    <div class="ribbon">
      <div class="ribbonTop">
        <div class="title">üéÖüéÑ Christmas Gift Trivia üéÅ‚ú®</div>
        <div class="pills">
          <div class="pill"><small>Gifts Won</small> <span id="giftsWonPill">0</span>/30</div>
          <div class="pill"><small>Deck Left</small> <span id="deckLeftPill">30</span></div>
          <div class="pill"><small>Wrong Reused</small> <span id="wrongReusePill">0</span></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- GAME -->
      <div class="card">
        <h1 style="margin:0 0 8px 0;">TV Mode</h1>
        <p class="sub">
          Exactly <b>30 questions</b>. A question only repeats if the player got it wrong.
          Wrong = skip turn + question goes to the end of the deck.
        </p>

        <!-- SETUP -->
        <div id="setup">
          <div class="row">
            <div class="field">
              <label for="playersInput">Players (one per line)</label>
              <textarea id="playersInput" placeholder="Mom&#10;Dad&#10;Marcus"></textarea>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button class="btnStart" id="startBtn">Start Game üéÑ</button>
            <button id="demoBtn">Quick Demo</button>
            <button class="btnDanger" id="resetBtn">Reset</button>
          </div>
        </div>

        <!-- PLAY -->
        <div id="game" style="display:none;">
          <div class="turnRow">
            <div class="turnChip">üë§ Turn: <span id="turnName">‚Äî</span></div>
            <div class="turnChip">‚≠ê Score: <span id="turnScore">0</span></div>
          </div>

          <div class="divider"></div>

          <div class="badge">
            <div>Q <span id="qCounter">1</span></div>
            <span>‚Ä¢ 30-question deck</span>
          </div>

          <div class="qtext" id="questionText">‚Äî</div>
          <p class="hint">Pick one answer:</p>
          <div class="choices" id="choices"></div>

          <div class="row" style="margin-top:14px;">
            <button class="btnNext" id="nextTurnBtn" disabled>Next Turn</button>
            <button id="restartBtn">Restart</button>
          </div>

          <div id="status" class="status"></div>
          <div id="pickGift" class="pickGift"></div>
        </div>
      </div>

      <!-- LEADERBOARD + ADMIN -->
      <div class="card">
        <h2>Leaderboard üèÜ</h2>
        <div style="border-radius: 18px; overflow:hidden; border: 1px solid rgba(255,255,255,.14); background: var(--card2);">
          <table class="scoreTable">
            <thead><tr><th>Name</th><th>Score</th></tr></thead>
            <tbody id="scoreBody">
              <tr><td colspan="2" style="color:var(--muted); font-weight:900;">Start a game to see scores.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="divider"></div>

        <h2>Admin (Replace Questions) üîí</h2>
        <div class="sub" style="margin-bottom:10px;">Password: <b>Marcus</b></div>

        <label for="adminPass">Password</label>
        <input id="adminPass" type="password" placeholder="Enter password to unlock admin" />

        <div class="row" style="margin-top:10px;">
          <button class="btnNext" id="unlockAdminBtn">Unlock</button>
          <button id="lockAdminBtn" disabled>Lock</button>
        </div>

        <div id="adminPanel" class="adminHidden" style="margin-top:14px;">
          <div class="divider"></div>

          <div class="sub" style="margin-bottom:10px;">
            This game uses exactly <b>30 questions</b>. Admin replaces a slot (1‚Äì30).
          </div>

          <label for="slotNum">Replace question slot (1‚Äì30)</label>
          <input id="slotNum" type="number" min="1" max="30" value="1" />

          <label for="newQ" style="margin-top:10px;">New question</label>
          <textarea id="newQ" placeholder="Type the question..."></textarea>

          <label for="newChoices" style="margin-top:10px;">Choices (4 lines = A, B, C, D)</label>
          <textarea id="newChoices" placeholder="A) ...&#10;B) ...&#10;C) ...&#10;D) ..."></textarea>

          <label for="correctIndex" style="margin-top:10px;">Correct choice</label>
          <select id="correctIndex">
            <option value="0">A</option>
            <option value="1">B</option>
            <option value="2">C</option>
            <option value="3">D</option>
          </select>

          <div class="row" style="margin-top:10px;">
            <button class="btnStart" id="saveReplaceBtn">Replace Slot ‚úÖ</button>
            <button class="btnDanger" id="restoreDefaultBtn">Restore Defaults</button>
          </div>

          <div class="sub" style="margin-top:10px;">Changes are saved in this browser.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Config ----------
  const ADMIN_PASSWORD = "Marcus";
  const LS_Q30 = "xmas_q30_mcq_v1";

  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function shuffle(arr){
    const a = arr.slice();
    for (let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function setStatus(type, msg){
    const el = $("status");
    el.className = "status show " + (type || "");
    el.textContent = msg;
  }
  function clearStatus(){
    const el = $("status");
    el.className = "status";
    el.textContent = "";
  }

  function showPickGift(text){
    const el = $("pickGift");
    el.classList.add("show");
    el.textContent = text;
  }
  function hidePickGift(){
    const el = $("pickGift");
    el.classList.remove("show");
    el.textContent = "";
  }

  // ---------- Default 30 Questions (UNIQUE) ----------
  const DEFAULT_30 = [
    { id:"Q01", q:"What do people usually put on top of a Christmas tree?", choices:["A star or angel","A shoe","A pumpkin","A kite"], correct:0 },
    { id:"Q02", q:"What red-and-white candy is popular at Christmas?", choices:["Candy cane","Jelly bean","Gummy worm","Chocolate egg"], correct:0 },
    { id:"Q03", q:"What animal pulls Santa‚Äôs sleigh?", choices:["Reindeer","Tigers","Zebras","Camels"], correct:0 },
    { id:"Q04", q:"What do people often hang by the fireplace for gifts?", choices:["Stockings","Backpacks","Pillows","Shoes"], correct:0 },
    { id:"Q05", q:"Where does Santa live in most stories?", choices:["North Pole","South Pole","New York City","The desert"], correct:0 },
    { id:"Q06", q:"What do people often leave out for Santa?", choices:["Cookies","Pizza","Hot dogs","Tacos"], correct:0 },
    { id:"Q07", q:"Which of these is a Christmas color?", choices:["Red","Orange","Purple","Neon pink"], correct:0 },
    { id:"Q08", q:"What‚Äôs the name of the famous Christmas snowman?", choices:["Frosty","Icy","Snowball","Blizzard"], correct:0 },
    { id:"Q09", q:"What do you call Christmas songs people sing?", choices:["Carols","Riddles","Raps","Spells"], correct:0 },
    { id:"Q10", q:"Which plant is famous for people kissing under it?", choices:["Mistletoe","Cactus","Palm tree","Bamboo"], correct:0 },
    { id:"Q11", q:"In the song, what did Rudolph have?", choices:["A red nose","Blue shoes","Green hair","A crown"], correct:0 },
    { id:"Q12", q:"What is the night before Christmas called?", choices:["Christmas Eve","Holiday Night","Snow Eve","Toy Night"], correct:0 },
    { id:"Q13", q:"What is Santa‚Äôs vehicle called?", choices:["Sleigh","Skateboard","Scooter","Submarine"], correct:0 },
    { id:"Q14", q:"What do you decorate with ornaments and lights?", choices:["A Christmas tree","A mailbox","A bathtub","A shoe"], correct:0 },
    { id:"Q15", q:"What‚Äôs a common Christmas decoration you hang on the door?", choices:["Wreath","Helmet","Spoon","Ladder"], correct:0 },
    { id:"Q16", q:"Which of these is a Christmas movie title?", choices:["Home Alone","Ocean Alone","House Together","Room Away"], correct:0 },
    { id:"Q17", q:"Which reindeer is the most famous?", choices:["Rudolph","Bobby","Shadow","Rocket"], correct:0 },
    { id:"Q18", q:"What‚Äôs the traditional drink made with eggs and spices?", choices:["Eggnog","Lemonade","Iced tea","Soda"], correct:0 },
    { id:"Q19", q:"Which one is a Christmas dessert?", choices:["Yule log","Nachos","Sushi","Burger"], correct:0 },
    { id:"Q20", q:"What do elves help Santa do?", choices:["Make toys","Build highways","Drive buses","Paint houses"], correct:0 },
    { id:"Q21", q:"What do you call a group of gifts wrapped up together?", choices:["Presents","Bricks","Leaves","Coins"], correct:0 },
    { id:"Q22", q:"Which of these is a winter month in the U.S.?", choices:["December","August","May","June"], correct:0 },
    { id:"Q23", q:"What do people sometimes do to count down to Christmas?", choices:["Advent calendar","Summer calendar","School schedule","Phone alarm"], correct:0 },
    { id:"Q24", q:"What‚Äôs the name of Santa‚Äôs workshop helpers?", choices:["Elves","Giants","Pirates","Dragons"], correct:0 },
    { id:"Q25", q:"What color is Santa‚Äôs suit usually shown as?", choices:["Red","Green","Blue","Black"], correct:0 },
    { id:"Q26", q:"What do you wrap gifts with?", choices:["Wrapping paper","Sand","Aluminum cans","Shoelaces"], correct:0 },
    { id:"Q27", q:"Which one is a Christmas decoration you hang on a tree?", choices:["Ornament","Tennis ball","Plate","Book"], correct:0 },
    { id:"Q28", q:"What do people often say during Christmas?", choices:["Merry Christmas","Happy Halloween","Happy New Year only","Good Morning only"], correct:0 },
    { id:"Q29", q:"What do you put on a tree to make it sparkle?", choices:["Lights","Dirt","Tape","Chalk"], correct:0 },
    { id:"Q30", q:"What does Santa deliver?", choices:["Gifts","Homework","Groceries only","Mail only"], correct:0 },
  ];

  function loadQ30(){
    try{
      const raw = localStorage.getItem(LS_Q30);
      if (!raw) return DEFAULT_30.slice();
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || parsed.length !== 30) return DEFAULT_30.slice();

      // Validate minimal structure
      const ok = parsed.every((x, i) =>
        x && typeof x.q === "string" &&
        Array.isArray(x.choices) && x.choices.length === 4 &&
        typeof x.correct === "number" && x.correct >= 0 && x.correct <= 3 &&
        typeof x.id === "string"
      );
      return ok ? parsed : DEFAULT_30.slice();
    }catch{
      return DEFAULT_30.slice();
    }
  }

  function saveQ30(list){
    localStorage.setItem(LS_Q30, JSON.stringify(list));
  }

  // ---------- Game State ----------
  const TOTAL_GIFTS = 30;
  let q30 = loadQ30();

  let deck = [];               // array of question objects in play order
  let currentQ = null;

  let players = [];            // [{name, score}]
  let turnIndex = 0;

  let giftsWon = 0;            // correct answers
  let wrongReuseCount = 0;     // number of wrong answers that requeued
  let questionCounterShown = 0;

  let awaitingNext = false;

  // ---------- UI ----------
  const setupEl = $("setup");
  const gameEl = $("game");

  const playersInput = $("playersInput");
  const turnNameEl = $("turnName");
  const turnScoreEl = $("turnScore");
  const qCounterEl = $("qCounter");
  const questionTextEl = $("questionText");
  const choicesEl = $("choices");
  const nextTurnBtn = $("nextTurnBtn");

  const giftsWonPill = $("giftsWonPill");
  const deckLeftPill = $("deckLeftPill");
  const wrongReusePill = $("wrongReusePill");

  const scoreBody = $("scoreBody");

  // Admin
  const adminPass = $("adminPass");
  const unlockAdminBtn = $("unlockAdminBtn");
  const lockAdminBtn = $("lockAdminBtn");
  const adminPanel = $("adminPanel");
  const slotNum = $("slotNum");
  const newQ = $("newQ");
  const newChoices = $("newChoices");
  const correctIndex = $("correctIndex");
  const saveReplaceBtn = $("saveReplaceBtn");
  const restoreDefaultBtn = $("restoreDefaultBtn");

  function parsePlayers(){
    const raw = (playersInput.value || "").split("\n").map(s=>s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for (const name of raw){
      const k = name.toLowerCase();
      if (!seen.has(k)){
        seen.add(k);
        out.push({ name, score: 0 });
      }
    }
    return out;
  }

  function renderScores(){
    if (!players.length){
      scoreBody.innerHTML = `<tr><td colspan="2" style="color:var(--muted); font-weight:900;">Start a game to see scores.</td></tr>`;
      return;
    }
    scoreBody.innerHTML = players.map((p, idx) => {
      const isTurn = idx === turnIndex;
      return `<tr><td>${isTurn ? "üëâ " : ""}${escapeHtml(p.name)}</td><td>${p.score}</td></tr>`;
    }).join("");
  }

  function setTurnUI(){
    const p = players[turnIndex];
    turnNameEl.textContent = p ? p.name : "‚Äî";
    turnScoreEl.textContent = p ? String(p.score) : "0";
    renderScores();
  }

  function updatePills(){
    giftsWonPill.textContent = String(giftsWon);
    deckLeftPill.textContent = String(deck.length);
    wrongReusePill.textContent = String(wrongReuseCount);
  }

  function disableChoices(disabled){
    [...choicesEl.querySelectorAll("button")].forEach(b => b.disabled = disabled);
  }

  function renderChoices(){
    choicesEl.innerHTML = "";
    const labels = ["A","B","C","D"];
    currentQ.choices.forEach((text, idx) => {
      const btn = document.createElement("button");
      btn.className = "choiceBtn";
      btn.innerHTML = `<span class="choiceLabel">${labels[idx]}</span>${escapeHtml(text)}`;
      btn.addEventListener("click", () => chooseAnswer(idx));
      choicesEl.appendChild(btn);
    });
  }

  function setStatus(type, msg){
    const el = $("status");
    el.className = "status show " + (type || "");
    el.textContent = msg;
  }
  function clearStatus(){
    const el = $("status");
    el.className = "status";
    el.textContent = "";
  }

  function showPickGift(msg){
    const el = $("pickGift");
    el.classList.add("show");
    el.textContent = msg;
  }
  function hidePickGift(){
    const el = $("pickGift");
    el.classList.remove("show");
    el.textContent = "";
  }

  function buildDeck(){
    // EXACTLY 30 questions, shuffled once at start
    q30 = loadQ30();
    deck = shuffle(q30);
  }

  function drawNextQuestion(){
    if (giftsWon >= TOTAL_GIFTS){
      endGame();
      return;
    }

    // If deck is empty but gifts not done (can happen only if all remaining are wrong-requeued weirdness),
    // reshuffle whatever questions remain in q30 that aren't "removed".
    if (deck.length === 0){
      // Safety fallback: rebuild a deck of unanswered questions (should be rare)
      deck = shuffle(q30);
    }

    currentQ = deck.shift();         // take from front
    questionCounterShown++;
    qCounterEl.textContent = String(questionCounterShown);

    questionTextEl.textContent = currentQ.q;
    renderChoices();
    disableChoices(false);

    awaitingNext = false;
    nextTurnBtn.disabled = true;

    clearStatus();
    hidePickGift();
    updatePills();
  }

  function chooseAnswer(idx){
    if (awaitingNext) return;

    const p = players[turnIndex];

    // Lock choices immediately so nobody can spam clicks
    disableChoices(true);
    awaitingNext = true;

    if (idx === currentQ.correct){
      // Correct: remove permanently by NOT re-adding
      p.score += 1;
      giftsWon += 1;

      setTurnUI();
      updatePills();

      setStatus("good", `‚úÖ Correct! ${p.name} gets +1 point. Go pick a gift! üéÅ`);
      showPickGift("üéÅ Pick ANY gift you want!");

      // If that was the 30th gift, end now
      if (giftsWon >= TOTAL_GIFTS){
        nextTurnBtn.textContent = "Finish üéâ";
      } else {
        nextTurnBtn.textContent = "Next Turn";
      }

    } else {
      // Wrong: re-use this question later by putting it at the END of the deck
      deck.push(currentQ);
      wrongReuseCount += 1;

      updatePills();

      const correctLetter = String.fromCharCode(65 + currentQ.correct);
      setStatus("bad", `‚ùå Wrong! Correct answer was ${correctLetter}. Turn skipped ‚Äî next person.`);
      hidePickGift();

      nextTurnBtn.textContent = "Next Turn";
    }

    nextTurnBtn.disabled = false;
  }

  function nextTurn(){
    if (giftsWon >= TOTAL_GIFTS){
      endGame();
      return;
    }

    // Always advance to next player AFTER an answer (correct or wrong)
    turnIndex = (turnIndex + 1) % players.length;
    setTurnUI();
    drawNextQuestion();
  }

  function endGame(){
    disableChoices(true);
    nextTurnBtn.disabled = true;

    questionTextEl.textContent = "Game Over üéÑ";
    choicesEl.innerHTML = "";

    // Find winner(s)
    const max = Math.max(...players.map(p=>p.score));
    const winners = players.filter(p=>p.score===max).map(p=>p.name);

    setStatus("good", `üéâ All 30 gifts are claimed! Winner: ${winners.join(", ")} with ${max} point(s)!`);
    showPickGift("üéÅ Enjoy your gifts!");
  }

  function startGame(){
    players = parsePlayers();
    if (players.length < 1){
      alert("Enter at least one player name (one per line).");
      return;
    }

    // Reset state
    turnIndex = 0;
    giftsWon = 0;
    wrongReuseCount = 0;
    questionCounterShown = 0;
    awaitingNext = false;

    buildDeck();
    setupEl.style.display = "none";
    gameEl.style.display = "block";

    setTurnUI();
    updatePills();
    drawNextQuestion();
  }

  function resetAll(){
    setupEl.style.display = "block";
    gameEl.style.display = "none";

    players = [];
    turnIndex = 0;
    giftsWon = 0;
    wrongReuseCount = 0;
    questionCounterShown = 0;
    awaitingNext = false;

    deck = [];
    currentQ = null;

    playersInput.value = "";
    giftsWonPill.textContent = "0";
    deckLeftPill.textContent = "30";
    wrongReusePill.textContent = "0";

    renderScores();
    clearStatus();
    hidePickGift();
  }

  // ---------- Admin: Replace slot ----------
  function lockAdmin(){
    adminPanel.classList.add("adminHidden");
    lockAdminBtn.disabled = true;
    unlockAdminBtn.disabled = false;
    adminPass.value = "";
    slotNum.value = 1;
    newQ.value = "";
    newChoices.value = "";
    correctIndex.value = "0";
  }

  function unlockAdmin(){
    if (adminPass.value !== ADMIN_PASSWORD){
      alert("Wrong password.");
      return;
    }
    adminPanel.classList.remove("adminHidden");
    lockAdminBtn.disabled = false;
    unlockAdminBtn.disabled = true;
  }

  function replaceSlot(){
    const slot = Number(slotNum.value);
    if (!Number.isFinite(slot) || slot < 1 || slot > 30){
      alert("Slot must be 1 to 30.");
      return;
    }

    const qText = (newQ.value || "").trim();
    const choiceLines = (newChoices.value || "").split("\n").map(s=>s.trim()).filter(Boolean);

    if (!qText){
      alert("Type a question.");
      return;
    }
    if (choiceLines.length !== 4){
      alert("Enter exactly 4 choices (one per line).");
      return;
    }

    const correct = Number(correctIndex.value);
    const list = loadQ30();
    const idx = slot - 1;

    list[idx] = {
      id: list[idx].id || ("Q" + String(slot).padStart(2,"0")),
      q: qText,
      choices: choiceLines,
      correct: Math.min(3, Math.max(0, correct|0))
    };

    saveQ30(list);
    q30 = list;

    alert(`Replaced slot #${slot}.`);

    // If game is running, rebuild deck from saved list (fresh)
    if (gameEl.style.display !== "none"){
      buildDeck();
      updatePills();
      drawNextQuestion();
    }

    newQ.value = "";
    newChoices.value = "";
    correctIndex.value = "0";
  }

  function restoreDefaults(){
    if (!confirm("Restore the original 30 questions?")) return;
    saveQ30(DEFAULT_30);
    q30 = DEFAULT_30.slice();
    alert("Restored defaults.");

    if (gameEl.style.display !== "none"){
      buildDeck();
      updatePills();
      drawNextQuestion();
    }
  }

  // ---------- Snow ----------
  function startSnow(){
    const snow = $("snow");
    snow.innerHTML = "";
    const flakeCount = 42;
    for (let i=0; i<flakeCount; i++){
      const f = document.createElement("div");
      f.className = "flake";
      const size = 3 + Math.random()*6;
      f.style.width = size + "px";
      f.style.height = size + "px";
      f.style.left = (Math.random()*100) + "vw";
      f.style.opacity = (0.35 + Math.random()*0.65).toFixed(2);
      const dur = 6 + Math.random()*10;
      f.style.animationDuration = dur + "s";
      f.style.animationDelay = (-Math.random()*dur) + "s";
      snow.appendChild(f);
    }
  }

  // ---------- Events ----------
  $("startBtn").addEventListener("click", startGame);
  $("demoBtn").addEventListener("click", () => {
    $("playersInput").value = "Mom\nMarcus";
    startGame();
  });
  $("resetBtn").addEventListener("click", resetAll);
  $("restartBtn").addEventListener("click", resetAll);
  $("nextTurnBtn").addEventListener("click", nextTurn);

  unlockAdminBtn.addEventListener("click", unlockAdmin);
  lockAdminBtn.addEventListener("click", lockAdmin);
  saveReplaceBtn.addEventListener("click", replaceSlot);
  restoreDefaultBtn.addEventListener("click", restoreDefaults);

  // init
  renderScores();
  lockAdmin();
  startSnow();
</script>
</body>
</html>
